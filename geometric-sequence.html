<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אתגר הסדרות - חקירה גרפית</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@1,600;1,700&display=swap');
        
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
            color: #1e293b; /* Slate 800 */
        }

        .math-serif {
            font-family: 'Crimson Text', serif;
            font-style: italic;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .graph-point {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .graph-point:hover {
            r: 5;
            filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5));
        }

        /* Checkbox custom style */
        .checkbox-wrapper input:checked + div {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
    </style>
</head>
<body class="h-screen w-screen bg-slate-50 text-slate-800 overflow-hidden">

<div id="root" class="h-full w-full"></div>

<script type="text/babel">

const { useState, useEffect, useMemo } = React;

// --- רכיב עזר לכתיב מתמטי ---
const MathText = ({ children, sub }) => (
    <span className="math-serif font-bold">
        {children}
        {sub && <sub className="not-italic text-[0.7em] ml-0.5">{sub}</sub>}
    </span>
);

// --- אייקונים ---
const Icons = {
    Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
    Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
    ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
    ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
    Brain: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
    Lightbulb: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.8-6-6-6S6 4.8 6 8c0 1.4.5 2.8 1.5 3.8.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
    Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
    Chart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>,
    Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
    Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
};

const Icon = ({ name, size = 20, className = "" }) => {
    const IconComponent = Icons[name];
    if (!IconComponent) return null;
    return <IconComponent width={size} height={size} className={className} />;
};

// --- עזרים לחישוב ---
const parseVal = (val) => {
    if (typeof val === 'number') return val;
    if (val === "?") return null;
    if (val.includes('/')) {
        const [n, d] = val.split('/');
        return parseInt(n) / parseInt(d);
    }
    return parseFloat(val);
};

// פונקציית עזר לבדיקת תשובה סלחנית
const checkAnswer = (input, validAnswers) => {
    const cleanInput = input.trim().toLowerCase();
    
    // בדיקה ישירה של מחרוזות
    if (validAnswers.includes(cleanInput)) return true;

    // ניסיון המרה למספר והשוואה (עם טווח שגיאה קטן)
    try {
        const inputNum = parseVal(cleanInput);
        if (isNaN(inputNum)) return false;

        for (let ans of validAnswers) {
            const ansNum = parseVal(ans);
            if (!isNaN(ansNum) && Math.abs(inputNum - ansNum) < 0.01) {
                return true;
            }
        }
    } catch (e) {
        return false;
    }
    return false;
};

// --- נתונים ---
const riddlesData = [
    {
        id: 1,
        title: "חידה מספר 1",
        sequence: [
            { n: 1, val: "2" },
            { n: 2, val: "3" },
            { n: 3, val: "6" },
            { n: 4, val: "7" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        answer: ["8", "שמונה"],
        hints: [
            "נסו לומר את המספרים בטור הימני (הערך) בקול רם.",
            "הקשיבו לצליל הראשון של כל מספר...",
            "שתיים, שלוש, שש, שבע... מה המשותף ומה הבא בתור?"
        ],
        explanation: "כל המספרים מתחילים באות ש'. המספר הבא שמתחיל ב-ש' הוא 8."
    },
    {
        id: 2,
        title: "חידה מספר 2",
        sequence: [
            { n: 1, val: "?" },
            { n: 2, val: "26" },
            { n: 3, val: "38" },
            { n: 4, val: "62" },
            { n: 5, val: "74" },
            { n: 6, val: "102" },
            { n: 7, val: "102" }
        ],
        targetN: 1, 
        answer: ["18", "22"],
        graphConfig: { stepY: 20 },
        hints: [
            "הסתכלו על ההפרש בין איבר בסדרה לבין זה שבא אחריו.",
            <>האיבר <MathText sub="2">a</MathText> הוא 26 וההפרש בינו לבין <MathText sub="3">a</MathText> הוא 12. מה הקשר בין 26 לבין 12?</>,
            "ההפרש הוא מכפלת הספרות של המספר הקודם. כדי למצוא את הראשון, צריך מספר שאם נוסיף לו את מכפלת ספרותיו נקבל 26."
        ],
        explanation: "החוקיות היא להוסיף למספר את מכפלת ספרותיו. 18 ועוד (1 כפול 8) שווה 26. (גם 22 היא תשובה נכונה: 22 ועוד 2 כפול 2 שווה 26)."
    },
    {
        id: 3,
        title: "חידה מספר 3",
        sequence: [
            { n: 1, val: "3" },
            { n: 2, val: "13" },
            { n: 3, val: "1113" },
            { n: 4, val: "3113" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        answer: ["132113"],
        hints: [
            "אל תחשבו מתמטיקה, תחשבו תיאור מילולי.",
            "קראו את המספר בשורה הקודמת משמאל לימין - כאילו אתם מקריאים רשימת מלאי.",
            "בשורה 4 רואים: שלוש פעמים 1, ואז פעם אחת 3. איך כותבים את זה?"
        ],
        explanation: "סדרת Look and Say. קוראים את 3113: 'פעם אחת 3 (13), פעמיים 1 (21), פעם אחת 3 (13)' -> 132113.",
        hideGraph: true 
    },
    {
        id: 4,
        title: "חידה מספר 4",
        sequence: [
            { n: 1, val: "1" },
            { n: 2, val: "1" },
            { n: 3, val: "2" },
            { n: 4, val: "3" },
            { n: 5, val: "5" },
            { n: 6, val: "8" },
            { n: 7, val: "?" }
        ],
        targetN: 7,
        answer: ["13"],
        hints: [
            "הסתכלו על ההפרש בין כל איבר לאיבר הבא אחריו.",
            "זו הסדרה המפורסמת ביותר בעולם."
        ],
        explanation: "סדרת פיבונאצ'י. כל איבר הוא סכום של שני קודמיו. 5+8=13."
    },
    {
        id: 5,
        title: "חידה מספר 5",
        sequence: [
            { n: 1, val: "2" },
            { n: 2, val: "1" },
            { n: 3, val: "3" },
            { n: 4, val: "4" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        answer: ["7"],
        hints: [
            "תוכלו לשאוב השראה מהחוקיות של הסדרה הקודמת.",
            <><MathText sub="1">a</MathText> + <MathText sub="2">a</MathText> = ?</>,
            <><MathText sub="2">a</MathText> + <MathText sub="3">a</MathText> = ?</>
        ],
        explanation: "סדרת לוקאס. החוקיות זהה לפיבונאצ'י (סכום שני הקודמים), אך ההתחלה שונה. 3+4=7.",
        bonus: "הידעת? סכום 10 האיברים הראשונים שווה ל-11 פעמים האיבר השביעי. נסו להוכיח זאת אלגברית."
    },
    {
        id: 6,
        title: "חידה מספר 6",
        type: 'geometric',
        qAnswer: "2",
        sequence: [
            { n: 1, val: "1/4" },
            { n: 2, val: "1/2" },
            { n: 3, val: "1" },
            { n: 4, val: "2" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        graphConfig: { stepY: 0.25 },
        answer: ["4"],
        hints: [
            "במה כופלים כל מספר כדי לקבל את הבא?",
            "פי כמה גדלנו בכל צעד?"
        ],
        explanation: "סדרה הנדסית עם מנה 2."
    },
    {
        id: 7,
        title: "חידה מספר 7",
        type: 'geometric',
        qAnswer: ["1/3", "0.33", "0.333"],
        sequence: [
            { n: 1, val: "27" },
            { n: 2, val: "9" },
            { n: 3, val: "3" },
            { n: 4, val: "1" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        graphConfig: { stepY: 10 },
        answer: ["1/3", "0.333", "0.33"],
        hints: [
            "אנחנו מתכווצים. פי כמה קטן המספר בכל צעד?",
            "מחלקים ב-3 כל פעם."
        ],
        explanation: "סדרה הנדסית עם מנה 1/3."
    },
    {
        id: 8,
        title: "חידה מספר 8",
        type: 'geometric',
        qAnswer: "-2",
        sequence: [
            { n: 1, val: "2" },
            { n: 2, val: "-4" },
            { n: 3, val: "8" },
            { n: 4, val: "-16" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        graphConfig: { stepY: 4 },
        answer: ["32"],
        hints: [
            "שימו לב לסימנים ולמספרים בנפרד.",
            "במה כופלים כדי להפוך חיובי לשלילי ושלילי לחיובי?",
            "המנה היא מספר שלילי."
        ],
        explanation: "סדרה הנדסית עם מנה -2. מינוס 16 כפול מינוס 2 שווה 32."
    },
    {
        id: 9,
        title: "חידה מספר 9",
        type: 'geometric',
        qAnswer: ["0.5", "1/2"],
        sequence: [
            { n: 1, val: "-16" },
            { n: 2, val: "-8" },
            { n: 3, val: "-4" },
            { n: 4, val: "-2" },
            { n: 5, val: "?" }
        ],
        targetN: 5,
        graphConfig: { stepY: 5 },
        answer: ["-1"],
        hints: [
            "שימו לב שהסימן (מינוס) נשמר לאורך כל הדרך.",
            "הערך המוחלט של המספרים הולך וקטן פי 2.",
            "במה כופלים -16 כדי לקבל -8?"
        ],
        explanation: <>סדרה הנדסית עם איבר ראשון שלילי ומנה חיובית (<MathText>q</MathText>=0.5). לכן הסדרה כולה שלילית ועולה (מתקרבת לאפס).</>
    },
    {
        id: 10,
        title: "חידה מספר 10",
        type: 'geometric',
        qAnswer: "2",
        sequence: [
            { n: 1, val: "?" },
            { n: 2, val: "?" },
            { n: 3, val: "3" },
            { n: 4, val: "6" },
            { n: 5, val: "12" }
        ],
        targetN: 1,
        revealedPoints: [{ n: 2, val: "1.5" }], 
        graphConfig: { stepY: 2 },
        answer: ["0.75", "3/4"],
        hints: [
            <>נתון האיבר השלישי (3) והרביעי (6). מה המנה (<MathText>q</MathText>)?</>,
            <>כדי ללכת אחורה (מ-<MathText sub="3">a</MathText> ל-<MathText sub="2">a</MathText>), צריך לחלק ב-<MathText>q</MathText>.</>,
            "תחלקו ב-2 פעמיים."
        ],
        explanation: <>המנה היא 2. לכן <MathText sub="2">a</MathText> = 3/2 = 1.5, ו-<MathText sub="1">a</MathText> = 1.5/2 = 0.75.</>
    }
];

// --- קומפוננטת גרף (Desmos Style) ---
const SequenceGraph = ({ sequence, isSolved, answer, targetN, revealedPoints, graphConfig }) => {
    
    // עיבוד נתונים
    const dataPoints = useMemo(() => {
        const points = sequence
            .filter(p => p.val !== "?")
            .map(p => ({ x: p.n, y: parseVal(p.val) }));
        
        // הוספת נקודת הפתרון אם נפתר
        if (isSolved && answer) {
            const ansVal = parseVal(answer[0]);
            // בדיקה אם הנקודה כבר קיימת
            if (!points.some(p => p.x === targetN)) {
                points.push({ x: targetN, y: ansVal, isNew: true });
            } else {
                const idx = points.findIndex(p => p.x === targetN);
                if (idx !== -1) points[idx].isNew = true;
            }

            // הוספת נקודות שנחשפו (אם יש)
            if (revealedPoints) {
                revealedPoints.forEach(rp => {
                    const rpVal = parseVal(rp.val);
                    if (!points.some(p => p.x === rp.n)) {
                        points.push({ x: rp.n, y: rpVal, isNew: true });
                    } else {
                        const idx = points.findIndex(p => p.x === rp.n);
                        if (idx !== -1) points[idx].isNew = true;
                    }
                });
            }
        }
        return points.sort((a, b) => a.x - b.x);
    }, [sequence, isSolved, answer, targetN, revealedPoints]);

    // חישוב גבולות
    const padding = 40;
    const width = 400; // viewBox units
    const height = 250;
    
    const xValues = dataPoints.map(p => p.x);
    const yValues = dataPoints.map(p => p.y);
    
    const minX = Math.min(0, ...xValues); 
    const maxX = Math.max(...xValues) + 1;
    
    // אם אין מספרים שליליים בנתונים, נתחיל את ציר ה-Y מ-0
    let minY = Math.min(...yValues) >= 0 ? 0 : Math.min(...yValues);
    let maxY = Math.max(...yValues);
    
    // התאמה לטווח שטוח או קטן
    if (maxY === minY) {
        maxY += 5;
        // אם 0, נאפשר ירידה מתחת, אחרת נשארים ב-0
        if (minY !== 0) minY -= 5;
    } else {
        const span = maxY - minY;
        maxY += span * 0.1;
        // רק אם כבר יש שליליים או שאנחנו ב-0, נרחיב למטה. אם הכל חיובי ומתחיל מ-0, נשאיר 0.
        if (minY < 0) {
             minY -= span * 0.1;
        }
    }

    
    // Margin לגרף
    const domainX = maxX - minX;
    const domainY = maxY - minY;

    const getX = (val) => padding + ((val - minX) / domainX) * (width - 2 * padding);
    const getY = (val) => height - padding - ((val - minY) / domainY) * (height - 2 * padding);

    // יצירת קווי רשת (Grid) - רק שלמים בציר X
    const xTicks = [];
    for (let i = Math.ceil(minX); i <= Math.floor(maxX); i++) {
        xTicks.push(i);
    }
    
    // Y Ticks - חישוב צעדים לפי קונפיגורציה או ברירת מחדל
    const yTicks = [];
    let stepY = 1;
    
    if (graphConfig && graphConfig.stepY) {
        stepY = graphConfig.stepY;
    } else {
        const rawStep = domainY / 5;
        stepY = Math.max(1, Math.ceil(rawStep));
    }
    
    // מייצרים טיקים בצעדים
    // מוצאים נקודת התחלה "עגולה" ביחס ל-stepY
    // למשל אם minY הוא -16 וstep הוא 5, נרצה להתחיל מ- -15 או -20.
    // עדיף להתחיל מ-0 וללכת לשני הכיוונים.
    
    // הוספת 0 תמיד
    // הוספת חיוביים
    for (let val = 0; val <= maxY; val += stepY) {
        if (!yTicks.includes(val)) yTicks.push(val);
    }
    // הוספת שליליים
    for (let val = -stepY; val >= minY; val -= stepY) {
        if (!yTicks.includes(val)) yTicks.push(val);
    }
    
    yTicks.sort((a, b) => a - b);

    // חיתוך ערכים מחוץ לטווח הגרפי הממשי (קצת יותר מ-minY/maxY זה בסדר לתצוגה)
    const displayTicks = yTicks.filter(t => t >= minY && t <= maxY);

    // X Axis Labels Y Position
    // אם ציר ה-X (ערך 0) נמצא בתוך הגרף, נמקם את המספרים קצת מתחתיו.
    // אם ציר ה-X הוא בתחתית, נמקם בתחתית.
    let xAxisLabelY = getY(0) + 15;
    // נדאג שלא יצא מגבולות הגרף התחתונים
    if (xAxisLabelY > height - 5) xAxisLabelY = height - 5; 

    return (
        <div className="w-full bg-white rounded-lg border border-slate-200 overflow-hidden mt-6">
            <div className="text-xs text-slate-400 font-bold px-4 pt-3 pb-1">גרף הסדרה</div>
            <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                <defs>
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L0,6 L9,3 z" fill="#64748b" />
                    </marker>
                </defs>

                {/* Grid Background */}
                <rect x="0" y="0" width={width} height={height} fill="white" />
                
                {/* Grid Lines Y */}
                {displayTicks.map((tick, i) => (
                    <g key={`y-${i}`}>
                        <line x1={padding} y1={getY(tick)} x2={width - padding} y2={getY(tick)} stroke="#e2e8f0" strokeWidth="1" />
                        <text x={padding - 12} y={getY(tick) + 3} textAnchor="end" fontSize="10" fill="#94a3b8" className="math-serif">
                            {Number.isInteger(tick) ? tick : tick.toFixed(2).replace(/\.?0+$/, '')}
                        </text>
                    </g>
                ))}

                {/* Grid Lines X */}
                {xTicks.map((tick, i) => (
                    <g key={`x-${i}`}>
                        <line x1={getX(tick)} y1={padding} x2={getX(tick)} y2={height - padding} stroke="#e2e8f0" strokeWidth="1" />
                        <text x={getX(tick)} y={xAxisLabelY} textAnchor="middle" fontSize="10" fill="#94a3b8" className="math-serif">
                            {tick}
                        </text>
                    </g>
                ))}

                {/* Axes with Arrows */}
                {/* Y Axis - Points UP */}
                <line x1={getX(0) < padding ? padding : getX(0)} y1={height - padding} x2={getX(0) < padding ? padding : getX(0)} y2={padding} stroke="#64748b" strokeWidth="2" markerEnd="url(#arrow)" />
                {/* X Axis */}
                <line x1={padding} y1={getY(0) > height - padding ? height - padding : getY(0)} x2={width - padding} y2={getY(0) > height - padding ? height - padding : getY(0)} stroke="#64748b" strokeWidth="2" markerEnd="url(#arrow)" />

                {/* Axis Labels */}
                <text x={width - padding + 15} y={getY(0) + 3} className="math-serif font-bold italic" fontSize="12" fill="#475569">n</text>
                <text x={getX(0) - 10} y={padding - 5} className="math-serif font-bold italic" fontSize="12" textAnchor="end" fill="#475569">a<tspan dy="3" fontSize="9">n</tspan></text>

                {/* Points */}
                {dataPoints.map((p, i) => (
                    <circle 
                        key={i}
                        cx={getX(p.x)} 
                        cy={getY(p.y)} 
                        r={p.isNew ? 5 : 3.5}
                        fill={p.isNew ? "#22c55e" : "#3b82f6"} // Green for answer, Blue for data
                        stroke="white"
                        strokeWidth="1.5"
                        className="graph-point"
                    >
                        <title>({p.x}, {p.y})</title>
                    </circle>
                ))}
            </svg>
        </div>
    );
};

// --- קומפוננטת רפלקציה קבועה ---
const ReflectionSection = ({ values, onUpdate }) => {
    // values = { q1: null/'yes'/'no', q2: null/'yes'/'no' }

    const ButtonGroup = ({ value, onChange }) => (
        <div className="flex gap-2">
            <button 
                onClick={() => onChange('yes')}
                className={`px-3 py-1 text-sm rounded-md transition-all border ${value === 'yes' ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}`}
            >
                כן
            </button>
            <button 
                onClick={() => onChange('no')}
                className={`px-3 py-1 text-sm rounded-md transition-all border ${value === 'no' ? 'bg-slate-600 text-white border-slate-600 shadow-sm' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}`}
            >
                לא
            </button>
        </div>
    );

    return (
        <div className="bg-slate-100/50 border border-slate-200 p-4 rounded-xl mt-8">
            <div className="flex items-center gap-2 mb-4 text-slate-500 text-xs font-bold uppercase tracking-wider">
                <Icon name="Brain" size={14} />
                רפלקציה עצמית (סמנו לעצמכם לטובת הדיון בכיתה)
            </div>
            
            <div className="space-y-4">
                <div className="flex items-center justify-between gap-4">
                    <span className="text-sm text-slate-600 leading-tight">
                        האם לדעתכם ניתן לכתוב <strong>הגדרה מתמטית בהירה</strong> לסדרה?
                    </span>
                    <ButtonGroup value={values?.q1} onChange={(val) => onUpdate('q1', val)} />
                </div>

                <div className="flex items-center justify-between gap-4">
                    <span className="text-sm text-slate-600 leading-tight">
                        האם לדעתכם ניתן לכתוב <strong>נוסחה פשוטה</strong> לחישוב איבר כללי בסדרה?
                    </span>
                    <ButtonGroup value={values?.q2} onChange={(val) => onUpdate('q2', val)} />
                </div>
            </div>
        </div>
    );
};

// --- רכיבים ראשיים ---

function Header({ onToggleSidebar }) {
    return (
        <header className="bg-white border-b border-slate-200 shadow-sm z-20 flex items-center justify-between px-4 py-4 md:px-8">
            <div className="flex items-center gap-4">
                <button 
                    onClick={onToggleSidebar}
                    className="md:hidden text-slate-600 hover:text-slate-800 focus:outline-none"
                >
                    <Icon name="Menu" size={24} />
                </button>
                <h1 className="text-xl md:text-2xl font-bold text-slate-800 leading-none">סדרות - פעילות מבוא לסדרה הנדסית</h1>
            </div>
        </header>
    );
}

function Footer() {
    return (
        <footer className="bg-white border-t border-slate-200 p-3 text-center z-10 w-full shrink-0">
            <div className="text-xs text-slate-500 leading-relaxed">
                נוצר ע"י <a href="https://tair-pnini.github.io" target="_blank" className="text-blue-600 hover:text-blue-800 font-bold underline transition-colors">תאיר פניני</a> | מוזמנים להשתמש ולהנות. אם לקחתם השראה נא תנו קרדיט.
                <span className="mx-2 text-slate-300">|</span>
                © כל הזכויות שמורות
            </div>
        </footer>
    );
}

function Sidebar({ riddles, progress, currentId, onSelect, isOpen, toggleSidebar }) {
    const solvedCount = Object.values(progress).filter(p => p.completed).length;
    
    return (
        <div className={`
            fixed inset-y-0 right-0 z-30 w-72 bg-white border-l border-slate-200 shadow-xl transform transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:flex flex-col md:shadow-none top-[60px] md:top-0 h-[calc(100%-60px)] md:h-full
            ${isOpen ? 'translate-x-0' : 'translate-x-full'}
        `}>
            
            {/* Sub-Header / Status */}
            <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <Icon name="Brain" className="text-blue-500" />
                        מפת הדרך
                    </h2>
                </div>
                
                {/* Progress */}
                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                    <div className="flex justify-between text-sm text-slate-600 mb-2 font-medium">
                        <span>הושלמו</span>
                        <span className="text-blue-600 font-bold">{solvedCount} מתוך {riddles.length}</span>
                    </div>
                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div 
                            className="bg-blue-500 h-full transition-all duration-500 rounded-full" 
                            style={{ width: `${(solvedCount / riddles.length) * 100}%` }}
                        ></div>
                    </div>
                </div>
            </div>

            {/* Riddle List */}
            <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-2 pb-20 md:pb-4">
                {riddles.map((riddle) => {
                    const status = progress[riddle.id] || { completed: false };
                    const isActive = currentId === riddle.id;
                    
                    return (
                        <button
                            key={riddle.id}
                            onClick={() => {
                                onSelect(riddle.id);
                                if (window.innerWidth < 768) toggleSidebar();
                            }}
                            className={`
                                w-full text-right p-3 rounded-lg text-sm transition-all duration-200 flex items-center justify-between
                                ${isActive 
                                    ? 'bg-blue-50 text-blue-700 font-bold border border-blue-200 shadow-sm' 
                                    : status.completed
                                        ? 'bg-white text-slate-500 border border-slate-100 hover:bg-slate-50' 
                                        : 'bg-white text-slate-600 border border-transparent hover:bg-slate-50'}
                            `}
                        >
                            <span className="flex items-center gap-2">
                                <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${isActive ? 'bg-blue-200 text-blue-800' : 'bg-slate-100 text-slate-500'}`}>
                                    {riddle.id}
                                </span>
                                {riddle.title}
                            </span>
                            {status.completed && (
                                <Icon name="Check" size={16} className="text-green-500" />
                            )}
                            {!status.completed && !isActive && (
                                <Icon name="Lock" size={14} className="text-slate-300" />
                            )}
                        </button>
                    );
                })}
            </div>
        </div>
    );
}

function MainContent({ riddle, status, onSolve, onHintReveal, onNext, onPrev, onReflectionUpdate }) {
    const [input, setInput] = useState("");
    const [qInput, setQInput] = useState("");
    const [errorState, setErrorState] = useState(false);
    
    const [phase, setPhase] = useState('solving_term'); 

    useEffect(() => {
        setInput("");
        setQInput("");
        setErrorState(false);
        setPhase(status?.completed ? 'success' : 'solving_term');
    }, [riddle.id, status]);

    const handleTermSubmit = (e) => {
        e.preventDefault();
        const cleanInput = input.trim().toLowerCase();
        
        if (checkAnswer(cleanInput, riddle.answer)) {
            if (status?.completed) {
                // Already done
            } else if (riddle.type === 'geometric') {
                setPhase('solving_q');
                setErrorState(false);
            } else {
                setPhase('success');
                onSolve(riddle.id);
            }
        } else {
            setErrorState(true);
            setTimeout(() => setErrorState(false), 800);
        }
    };

    const handleQSubmit = (e) => {
        e.preventDefault();
        const cleanInput = qInput.trim().toLowerCase();
        
        const validAnswers = Array.isArray(riddle.qAnswer) ? riddle.qAnswer : [riddle.qAnswer];
        
        if (checkAnswer(cleanInput, validAnswers)) {
            setPhase('success');
            onSolve(riddle.id);
        } else {
            setErrorState(true);
            setTimeout(() => setErrorState(false), 800);
        }
    };

    const isSolved = phase === 'success';
    const hintsShown = status?.hintsRevealed || 0;

    return (
        <div className="flex-1 h-full overflow-y-auto custom-scroll flex flex-col relative bg-slate-50">
            
            <div className="p-4 md:p-10 max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-2 gap-8 items-start pt-8 md:pt-10 pb-20">
                
                {/* Interaction Area (Right on Desktop, Second on Mobile) */}
                <div className="flex flex-col gap-6 order-2 lg:order-1">
                    
                    <div className="mb-2">
                        <h2 className="text-2xl font-bold text-slate-800">{riddle.title}</h2>
                    </div>

                    {/* Phase 1: Term Answer */}
                    {phase === 'solving_term' && (
                        <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                            <label className="block text-sm font-bold text-slate-700 mb-3">השלימו את האיבר החסר:</label>
                            <form onSubmit={handleTermSubmit} className="flex items-center gap-3" dir="ltr">
                                <span className="math-serif text-2xl text-slate-600 italic font-bold">
                                    a<sub className="not-italic text-sm">{riddle.targetN}</sub> =
                                </span>
                                <input
                                    type="text"
                                    inputMode="decimal"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    className={`
                                        w-32 bg-slate-50 border-b-2 px-2 py-1 text-2xl font-bold text-slate-800 outline-none transition-all text-center math-serif
                                        ${errorState ? 'border-red-400 bg-red-50 text-red-600' : 'border-slate-300 focus:border-blue-500'}
                                    `}
                                    placeholder="?"
                                    autoFocus
                                    autoComplete="off"
                                />
                                <button 
                                    type="submit"
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition-transform active:scale-95 ml-2"
                                >
                                    בדיקה
                                </button>
                            </form>
                            {errorState && <p className="text-sm text-red-500 mt-2 font-medium" dir="rtl">נסו שוב...</p>}
                        </div>
                    )}

                    {/* Phase 2: Q Answer */}
                    {phase === 'solving_q' && (
                        <div className="bg-indigo-50 border border-indigo-100 p-6 rounded-2xl shadow-sm animate-in fade-in slide-in-from-bottom-2">
                             <div className="flex items-center gap-2 mb-2 text-indigo-700 font-bold">
                                <Icon name="Calculator" size={18} />
                                <span>פיצחתם את האיבר!</span>
                            </div>
                            <p className="text-slate-700 text-sm leading-relaxed mb-4">
                                זוהי סדרה הנדסית! כל איבר בה (החל מ-<MathText sub="2">a</MathText>) 
                                גדול פי <MathText>q</MathText> מהאיבר הקודם לו.
                            </p>
                            <label className="block text-sm font-bold text-slate-700 mb-2">מהו <MathText>q</MathText> במקרה זה?</label>
                            
                            <form onSubmit={handleQSubmit} className="flex items-center gap-3" dir="ltr">
                                <span className="math-serif text-2xl text-slate-600 italic font-bold">
                                    q =
                                </span>
                                <input
                                    type="text"
                                    inputMode="decimal"
                                    value={qInput}
                                    onChange={(e) => setQInput(e.target.value)}
                                    className={`
                                        w-32 bg-white border-b-2 px-2 py-1 text-2xl font-bold text-slate-800 outline-none transition-all text-center math-serif
                                        ${errorState ? 'border-red-400 bg-red-50 text-red-600' : 'border-indigo-300 focus:border-indigo-500'}
                                    `}
                                    placeholder="?"
                                    autoFocus
                                    autoComplete="off"
                                />
                                <button 
                                    type="submit"
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition-transform active:scale-95 ml-2"
                                >
                                    בדיקה
                                </button>
                            </form>
                             {errorState && <p className="text-sm text-red-500 mt-2 font-medium" dir="rtl">ערך ה-q אינו נכון. נסו שוב.</p>}
                        </div>
                    )}

                    {/* Phase 3: Success */}
                    {phase === 'success' && (
                        <div className="bg-green-50 border border-green-100 p-6 rounded-2xl shadow-sm animate-in fade-in slide-in-from-bottom-4">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="bg-green-100 p-2 rounded-full text-green-600">
                                    <Icon name="Check" size={20} />
                                </div>
                                <h3 className="font-bold text-green-800 text-lg">מצוין!</h3>
                            </div>
                            <p className="text-slate-700 leading-relaxed mb-4">
                                {riddle.explanation}
                            </p>
                            {riddle.bonus && (
                                <div className="mt-2 pt-3 border-t border-green-200 text-sm text-green-800 bg-green-100/50 p-3 rounded-lg">
                                    <strong>✨ בונוס למחשבה:</strong> {riddle.bonus}
                                </div>
                            )}
                            <div className="flex gap-3 mt-4">
                                <button onClick={onNext} className="text-green-700 font-bold hover:underline flex items-center gap-1 text-sm">
                                    לחידה הבאה <Icon name="ChevronLeft" size={16} />
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Hints */}
                    {(phase === 'solving_term' || phase === 'solving_q') && (
                        <div className="space-y-3">
                            <div className="flex items-center justify-between">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wide">עזרה ורמזים</h3>
                                {hintsShown < riddle.hints.length && (
                                    <button 
                                        onClick={() => onHintReveal(riddle.id)}
                                        className="text-xs bg-white border border-slate-200 text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-full font-medium transition-colors flex items-center gap-1 shadow-sm"
                                    >
                                        <Icon name="Lightbulb" size={14} />
                                        קבל רמז
                                    </button>
                                )}
                            </div>

                            {hintsShown === 0 ? (
                                <div className="text-slate-400 text-sm italic text-center py-4 bg-slate-100/50 rounded-xl border border-dashed border-slate-200">
                                    צריכים עזרה? בקשו רמז למעלה
                                </div>
                            ) : (
                                <div className="space-y-3 animate-in fade-in slide-in-from-bottom-2">
                                    {riddle.hints.slice(0, hintsShown).map((hint, i) => (
                                        <div key={i} className="bg-yellow-50 border border-yellow-100 p-4 rounded-xl text-slate-700 text-sm shadow-sm flex gap-3">
                                            <div className="bg-yellow-100 w-6 h-6 rounded-full flex items-center justify-center shrink-0 text-yellow-700 text-xs font-bold">
                                                {i + 1}
                                            </div>
                                            <p>{hint}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Reflection */}
                    <ReflectionSection values={status?.reflection} onUpdate={(key, val) => onReflectionUpdate(riddle.id, key, val)} />

                    {/* Navigation Buttons (Bottom) */}
                    <div className="flex justify-between pt-6 border-t border-slate-100">
                        <button onClick={onPrev} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                            <Icon name="ChevronRight" size={16} /> הקודם
                        </button>
                        <button onClick={onNext} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                            הבא <Icon name="ChevronLeft" size={16} />
                        </button>
                    </div>

                </div>

                {/* Sequence & Graph (Left on Desktop, First on Mobile) */}
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 order-1 lg:order-2">
                    <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-3">
                        <h2 className="font-bold text-slate-700">הסדרה הנתונה</h2>
                        <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">חקירה</span>
                    </div>
                    
                    {/* Table */}
                    <div className="max-h-60 overflow-y-auto custom-scroll pr-2">
                         <div className="flex justify-between px-3 text-xl text-slate-500 font-bold mb-2 tracking-wider math-serif" dir="ltr">
                            <span>n</span>
                            <span>a<sub>n</sub></span>
                        </div>
                        <div className="space-y-1">
                            {riddle.sequence.map((item, idx) => (
                                <div key={idx} className="flex items-center justify-between px-3 py-2 rounded bg-slate-50 border border-slate-100 text-sm" dir="ltr">
                                    <div className="font-bold text-slate-500 math-serif italic">
                                        {item.n}
                                    </div>
                                    <div className="text-slate-300 text-xs">➜</div>
                                    <div className={`font-bold math-serif ${item.val === "?" ? "text-blue-600" : "text-slate-700"}`}>
                                        {item.val === "?" && isSolved 
                                            ? (riddle.id === 10 && item.n === 2 ? "1.5" : (riddle.id === 2 && item.n === 1 ? riddle.answer[0] : item.val))
                                            : item.val}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {!riddle.hideGraph && (
                        <SequenceGraph sequence={riddle.sequence} isSolved={isSolved} answer={riddle.answer} targetN={riddle.targetN} revealedPoints={riddle.revealedPoints} graphConfig={riddle.graphConfig} />
                    )}
                </div>

            </div>
        </div>
    );
}

function App() {
    const [currentId, setCurrentId] = useState(1);
    const [progress, setProgress] = useState(() => {
        const initial = {};
        riddlesData.forEach(r => initial[r.id] = { completed: false, hintsRevealed: 0, reflection: { q1: null, q2: null } });
        return initial;
    });
    const [isSidebarOpen, setSidebarOpen] = useState(false);

    const handleSolve = (id) => {
        setProgress(prev => ({
            ...prev,
            [id]: { ...prev[id], completed: true }
        }));
    };

    const handleHintReveal = (id) => {
        setProgress(prev => {
            const currentHints = prev[id].hintsRevealed;
            const maxHints = riddlesData.find(r => r.id === id).hints.length;
            if (currentHints < maxHints) {
                return {
                    ...prev,
                    [id]: { ...prev[id], hintsRevealed: currentHints + 1 }
                };
            }
            return prev;
        });
    };

    const handleReflectionUpdate = (id, key, value) => {
         setProgress(prev => ({
            ...prev,
            [id]: {
                ...prev[id],
                reflection: { ...prev[id].reflection, [key]: value }
            }
        }));
    };

    const navigate = (direction) => {
        const currentIndex = riddlesData.findIndex(r => r.id === currentId);
        if (direction === 'next') {
            const nextIndex = (currentIndex + 1) % riddlesData.length;
            setCurrentId(riddlesData[nextIndex].id);
        } else {
            const prevIndex = (currentIndex - 1 + riddlesData.length) % riddlesData.length;
            setCurrentId(riddlesData[prevIndex].id);
        }
    };

    const currentRiddle = riddlesData.find(r => r.id === currentId);
    const currentStatus = progress[currentId];

    return (
        <div className="flex flex-col h-[100dvh] w-screen bg-slate-50 overflow-hidden" dir="rtl">
            
            <Header onToggleSidebar={() => setSidebarOpen(!isSidebarOpen)} />

            <div className="flex flex-1 overflow-hidden relative">
                <Sidebar 
                    riddles={riddlesData} 
                    progress={progress} 
                    currentId={currentId} 
                    onSelect={setCurrentId}
                    isOpen={isSidebarOpen}
                    toggleSidebar={() => setSidebarOpen(!isSidebarOpen)}
                />

                <MainContent 
                    riddle={currentRiddle}
                    status={currentStatus}
                    onSolve={handleSolve}
                    onHintReveal={handleHintReveal}
                    onNext={() => navigate('next')}
                    onPrev={() => navigate('prev')}
                    onReflectionUpdate={handleReflectionUpdate}
                />
            </div>
            
            <Footer />
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

</script>
</body>
</html>
